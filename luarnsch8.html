<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¬’è€å¸« Dr. Luarn - æ™ºæ…§äº’å‹•è³‡è¨Šçœ‹æ¿</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;800&family=JetBrains+Mono:wght@700&family=Noto+Sans+TC:wght@300;500;900&display=swap" rel="stylesheet">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    
    <style>
        :root { --bg-deep: #020617; }
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #000000;
            color: white;
            margin: 0; padding: 0; overflow: hidden; height: 100vh; width: 100vw;
        }
        .depth-3d {
            transform: perspective(1000px) rotateX(2deg);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5), inset 0 1px 1px rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.05);
        }
        .btn-3d {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 0 rgba(0,0,0,0.2), 0 15px 20px rgba(0,0,0,0.3);
        }
        .btn-3d:active {
            transform: translateY(4px);
            box-shadow: 0 4px 0 rgba(0,0,0,0.2), 0 5px 10px rgba(0,0,0,0.3);
        }
        .glass-texture {
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.02) 100%);
            backdrop-filter: blur(20px);
        }
        
        /* è¦–è¦ºåé¥‹å‹•ç•« (æ‰‹å‹¢è§¸ç™¼) */
        @keyframes flash-feedback {
            0% { background-color: rgba(255,255,255,0.1); }
            50% { background-color: rgba(255, 0, 100, 0.5); }
            100% { background-color: rgba(255,255,255,0.1); }
        }
        .color-changed { animation: flash-feedback 0.3s ease-out; }

        /* ä¸»è¦çš„é¡è‰²è®Šæ›å‹•ç•« */
        @keyframes pastel-shift {
            0%, 100% { color: #ffffff !important; text-shadow: 0 0 30px rgba(255,255,255,0.6); }
            16% { color: #ff1493 !important; text-shadow: 0 0 40px rgba(255,20,147,0.9); }
            33% { color: #ffd700 !important; text-shadow: 0 0 40px rgba(255,215,0,0.9); }
            50% { color: #00bfff !important; text-shadow: 0 0 40px rgba(0,191,255,0.9); }
            66% { color: #00ff7f !important; text-shadow: 0 0 40px rgba(0,255,127,0.9); }
            83% { color: #ff6347 !important; text-shadow: 0 0 40px rgba(255,99,71,0.9); }
        }
        
        /* å¿«é€Ÿè®ŠåŒ–å‹•ç•« */
        @keyframes pastel-shift-fast {
            0%, 100% { color: #ffffff; }
            20% { color: #ff69b4; }
            40% { color: #ffd700; }
            60% { color: #87ceeb; }
            80% { color: #98fb98; }
        }
        
        /* æ…¢é€Ÿè®ŠåŒ–å‹•ç•« */
        @keyframes pastel-shift-slow {
            0%, 100% { color: #ffffff; }
            25% { color: #ff69b4; }
            50% { color: #87ceeb; }
            75% { color: #98fb98; }
        }
        
        /* å…¨åŸŸæ–‡å­—è®Šè‰²æ•ˆæœ */
        body {
            animation: pastel-shift-slow 40s ease-in-out infinite;
        }
        
        /* ä¸»è¦å…§å®¹å€åŸŸ */
        .text-pastel-cycle,
        .title-area span,
        .title-area div,
        main h1, main h2, main h3,
        main p, main span {
            animation: pastel-shift 12s ease-in-out infinite !important;
        }
        
        /* æŒ‰éˆ•æ–‡å­— - å¿«é€Ÿè®ŠåŒ– */
        button:not(.bg-white):not(.bg-slate-100) {
            animation: pastel-shift-fast 15s ease-in-out infinite;
        }
        
        /* ä¿æŒæŸäº›å…ƒç´ ä¸è®Šè‰² */
        .text-pink-400, .text-pink-500,
        .text-blue-600, .text-indigo-400, .text-indigo-500,
        .text-green-600, .text-green-800,
        .text-amber-400, .text-amber-100,
        .text-red-500, .text-red-600,
        .bg-white *, .bg-slate-50 *,
        input, textarea, select {
            animation: none !important;
        }
        
        .toolbar-btn { animation: pastel-shift-slow 30s ease-in-out infinite; }
        .modal-content { animation: pastel-shift-slow 35s ease-in-out infinite; }
        
        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 1024px) {
            .title-area { 
                top: 0.5rem !important; 
                transform: scale(0.7) !important; 
            }
            .avatar-box { 
                width: 5rem !important; 
                height: 5rem !important; 
                top: 0.5rem !important; 
                left: 0.5rem !important; 
            }
        }
        
        @media (max-width: 768px) {
            body {
                overflow-y: auto;
                overflow-x: hidden;
                height: auto;
                min-height: 100vh;
            }
            .title-area { 
                position: relative !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                transform: scale(1) !important;
                padding: 1rem 0.5rem !important;
            }
            .avatar-box { 
                position: relative !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: auto !important;
                display: flex !important;
                justify-content: center !important;
                margin-bottom: 1rem !important;
            }
            canvas { 
                /* ç¢ºä¿ Three.js canvas åœ¨æ‰‹æ©Ÿä¸Šä¹Ÿé¡¯ç¤º */
                display: block !important; 
            }
            body { background: #000; }
        }
        
        @media (max-width: 480px) {
            .title-area span { font-size: 1.8rem !important; }
        }
        
        #video-input { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;
        
        // Constants
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/1GPi-84ocA56qJrzGoN6ocmt27Fmc1iHJ-qxScqsHVvE/export?format=csv";
        const N8N_WEBHOOK_URL = "https://a3g.app.n8n.cloud/webhook/sch_wh";
        const DAYS_ZH = ["æ˜ŸæœŸæ—¥", "æ˜ŸæœŸä¸€", "æ˜ŸæœŸäºŒ", "æ˜ŸæœŸä¸‰", "æ˜ŸæœŸå››", "æ˜ŸæœŸäº”", "æ˜ŸæœŸå…­"];
        
        const DEFAULT_SLOTS = [
          { id: '1', name: 'ç¬¬ä¸€ç¯€', start: '08:10', end: '09:00' },
          { id: '2', name: 'ç¬¬äºŒç¯€', start: '09:10', end: '10:00' },
          { id: '3', name: 'ç¬¬ä¸‰ç¯€', start: '10:20', end: '11:10' },
          { id: '4', name: 'ç¬¬å››ç¯€', start: '11:20', end: '12:10' },
          { id: '5', name: 'ç¬¬äº”ç¯€', start: '12:20', end: '13:10' },
          { id: '6', name: 'ç¬¬å…­ç¯€', start: '13:20', end: '14:10' },
          { id: '7', name: 'ç¬¬ä¸ƒç¯€', start: '14:20', end: '15:10' },
          { id: '8', name: 'ç¬¬å…«ç¯€', start: '15:30', end: '16:20' },
          { id: '9', name: 'ç¬¬ä¹ç¯€', start: '16:30', end: '17:20' },
          { id: '10', name: 'ç¬¬åç¯€', start: '17:30', end: '18:20' },
          { id: '11', name: 'ç¬¬Aç¯€', start: '18:25', end: '19:15' },
          { id: '12', name: 'ç¬¬Bç¯€', start: '19:20', end: '20:10' },
          { id: '13', name: 'ç¬¬Cç¯€', start: '20:15', end: '21:05' },
        ];

        const DEFAULT_TEMPLATES = [
          { id: '1', btnName: 'ä¸‹èª²ä¼‘æ¯', title: 'ä¸‹èª²æ™‚é–“', subtitle: 'é›¢é–‹æ•™å®¤è«‹æ³¨æ„å®‰å…¨' },
          { id: '2', btnName: 'å®‰éœåˆä¼‘', title: 'åˆä¼‘æ™‚é–“', subtitle: 'è«‹ä¿æŒå®‰éœï¼Œå®‰éœåˆç¡' },
          { id: '3', btnName: 'æ‰“æƒæ™‚é–“', title: 'ç’°å¢ƒæ¸…æƒ', subtitle: 'ç¶­è­·æ ¡åœ’æ•´æ½”ï¼Œå¤§å®¶å‹•èµ·ä¾†' },
        ];

        // 3D Gesture Particles Background Component
        function GestureParticlesBackground() {
            const containerRef = useRef(null);
            const videoRef = useRef(null);
            const [status, setStatus] = useState("åˆå§‹åŒ–ä¸­...");
            const [gesture, setGesture] = useState("ç­‰å¾…æ‰‹å‹¢");
            const [currentShape, setCurrentShape] = useState("FIREWORKS");
            const [isActive, setIsActive] = useState(false); // æ˜¯å¦æœ‰åµæ¸¬åˆ°æ‰‹

            useEffect(() => {
                let cameraUtils = null;
                let hands = null;
                let renderer = null;
                let animationId = null;

                const init3D = async () => {
                    const container = containerRef.current;
                    const videoElement = videoRef.current;
                    if (!container || !videoElement) return;

                    // --- Three.js Setup ---
                    const scene = new THREE.Scene();
                    scene.fog = new THREE.FogExp2(0x000000, 0.003);

                    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                    camera.position.z = 35;

                    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                    renderer.setSize(window.innerWidth, window.innerHeight);
                    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                    
                    // é‡é»ä¿®æ­£ï¼šå°‡æ¸²æŸ“å™¨åŠ åˆ° div å®¹å™¨ä¸­ï¼Œè€Œä¸æ˜¯ canvas æ¨™ç±¤å…§
                    while(container.firstChild){
                        container.removeChild(container.firstChild);
                    }
                    container.appendChild(renderer.domElement);

                    const particleCount = 4500;
                    const geometry = new THREE.BufferGeometry();
                    const positions = new Float32Array(particleCount * 3);
                    const colors = new Float32Array(particleCount * 3);
                    const targetPositions = new Float32Array(particleCount * 3);

                    // Initial positions
                    const tempColor = new THREE.Color();
                    for (let i = 0; i < particleCount * 3; i++) {
                        positions[i] = (Math.random() - 0.5) * 60;
                        targetPositions[i] = positions[i];
                        
                        tempColor.setHSL(0.5 + Math.random() * 0.1, 0.8, 0.5);
                        colors[i] = tempColor.r;
                        colors[i+1] = tempColor.g;
                        colors[i+2] = tempColor.b;
                    }

                    geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                    geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

                    const material = new THREE.PointsMaterial({
                        size: 0.4,
                        vertexColors: true,
                        blending: THREE.AdditiveBlending,
                        depthTest: false,
                        transparent: true,
                        opacity: 0.8
                    });

                    const particles = new THREE.Points(geometry, material);
                    scene.add(particles);

                    // --- Shapes Logic ---
                    const shapes = {
                        heart: (i) => {
                            const t = Math.random() * Math.PI * 2;
                            const x = 16 * Math.pow(Math.sin(t), 3);
                            const y = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
                            const z = (Math.random() - 0.5) * 6;
                            return [x * 0.6, y * 0.6, z];
                        },
                        flower: (i) => {
                            const spread = 0.6;
                            const angle = 137.5 * (Math.PI / 180) * i;
                            const r = spread * Math.sqrt(i);
                            const x = r * Math.cos(angle);
                            const y = r * Math.sin(angle);
                            const z = Math.sin(r * 0.4) * 8;
                            return [x, y, z];
                        },
                        saturn: (i) => {
                            const isRing = Math.random() > 0.5;
                            if (isRing) {
                                const angle = Math.random() * Math.PI * 2;
                                const r = 14 + Math.random() * 6;
                                return [r * Math.cos(angle), r * Math.sin(angle) * 0.15, r * Math.sin(angle) * 0.8];
                            } else {
                                const r = 9;
                                const theta = Math.random() * Math.PI * 2;
                                const phi = Math.acos(2 * Math.random() - 1);
                                return [r * Math.sin(phi) * Math.cos(theta), r * Math.sin(phi) * Math.sin(theta), r * Math.cos(phi)];
                            }
                        },
                        buddha: (i) => {
                            const u = Math.random() * Math.PI * 2;
                            const v = Math.random() * Math.PI * 2;
                            const p = 2, q = 3;
                            const r = 8 + Math.cos(q * v) * 2;
                            const x = r * Math.cos(p * u);
                            const y = r * Math.sin(p * u);
                            const z = Math.sin(q * v) * 5 + (Math.random()-0.5)*2;
                            return [x, y, z];
                        },
                        fireworks: (i) => {
                            const r = Math.random() * 25;
                            const theta = Math.random() * Math.PI * 2;
                            const phi = Math.acos(2 * Math.random() - 1);
                            return [r * Math.sin(phi) * Math.cos(theta), r * Math.sin(phi) * Math.sin(theta), r * Math.cos(phi)];
                        }
                    };
                    const shapeKeys = Object.keys(shapes);

                    function setTargetShape(shapeName) {
                        setCurrentShape(shapeName.toUpperCase());
                        const generator = shapes[shapeName];
                        for (let i = 0; i < particleCount; i++) {
                            const [x, y, z] = generator(i);
                            targetPositions[i * 3] = x;
                            targetPositions[i * 3 + 1] = y;
                            targetPositions[i * 3 + 2] = z;
                        }
                    }

                    function changeColors() {
                        // Visual feedback via DOM logic for performance (React state might be too slow for flash effect)
                        const feedbackEl = document.getElementById('gesture-feedback-box');
                        if (feedbackEl) {
                            feedbackEl.classList.remove('color-changed');
                            void feedbackEl.offsetWidth; 
                            feedbackEl.classList.add('color-changed');
                        }

                        const mainHue = Math.random(); 
                        const isMultiColor = Math.random() > 0.8;
                        const colorHelper = new THREE.Color();
                        const attr = geometry.attributes.color;

                        for (let i = 0; i < particleCount; i++) {
                            if (isMultiColor) {
                                colorHelper.setHSL(Math.random(), 1.0, 0.6);
                            } else {
                                colorHelper.setHSL(mainHue + (Math.random()-0.5)*0.1, 0.9, 0.5 + Math.random()*0.3);
                            }
                            attr.setXYZ(i, colorHelper.r, colorHelper.g, colorHelper.b);
                        }
                        attr.needsUpdate = true;
                    }

                    // Initial shape
                    setTargetShape('fireworks');

                    // --- MediaPipe Logic ---
                    let handScale = 1.0;
                    let gestureDebounce = 0;
                    let lastGesture = 'none';

                    function onResults(results) {
                        setStatus("åµæ¸¬ä¸­...");
                        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                            setIsActive(true);
                            const lm = results.multiHandLandmarks[0];
                            const wrist = lm[0];
                            const middleBase = lm[9];
                            const palmSize = Math.sqrt(Math.pow(wrist.x - middleBase.x, 2) + Math.pow(wrist.y - middleBase.y, 2));
                            
                            // Distance scale
                            const targetScale = 0.5 + (palmSize * 6);
                            handScale += (targetScale - handScale) * 0.1;

                            // Finger Open/Close detection
                            const tips = [8, 12, 16, 20];
                            const mcp = [5, 9, 13, 17];
                            let openScore = 0;
                            for(let i=0; i<4; i++) {
                                const tipToWrist = Math.sqrt(Math.pow(lm[tips[i]].x - wrist.x, 2) + Math.pow(lm[tips[i]].y - wrist.y, 2));
                                const mcpToWrist = Math.sqrt(Math.pow(lm[mcp[i]].x - wrist.x, 2) + Math.pow(lm[mcp[i]].y - wrist.y, 2));
                                if (tipToWrist > mcpToWrist * 1.3) openScore++;
                            }

                            let currentGesture = 'neutral';
                            if (openScore >= 3) currentGesture = 'open';
                            else {
                                 let avgTipDist = 0;
                                 tips.forEach(i => {
                                    avgTipDist += Math.sqrt(Math.pow(lm[i].x - lm[0].x, 2) + Math.pow(lm[i].y - lm[0].y, 2));
                                 });
                                 avgTipDist /= 4;
                                 const ratio = avgTipDist / palmSize;
                                 if (ratio < 1.0) currentGesture = 'closed';
                            }

                            if(currentGesture === 'open') setGesture("å¼µé–‹ (Open)");
                            else if(currentGesture === 'closed') setGesture("æ¡æ‹³ (Closed)");
                            else setGesture("ä¸€èˆ¬ (Neutral)");
                            
                            const now = Date.now();
                            if (now - gestureDebounce > 500) {
                                if (currentGesture === 'open' && lastGesture !== 'open') {
                                    const next = shapeKeys[Math.floor(Math.random() * shapeKeys.length)];
                                    setTargetShape(next);
                                    gestureDebounce = now;
                                } 
                                else if (currentGesture === 'closed' && lastGesture !== 'closed') {
                                    changeColors();
                                    gestureDebounce = now;
                                }
                            }
                            lastGesture = currentGesture;

                        } else {
                            setIsActive(false);
                            setGesture("æœªåµæ¸¬åˆ°æ‰‹éƒ¨");
                            handScale += (1.0 - handScale) * 0.05;
                        }
                    }

                    hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
                    hands.setOptions({
                        maxNumHands: 1,
                        modelComplexity: 1,
                        minDetectionConfidence: 0.6,
                        minTrackingConfidence: 0.6
                    });
                    hands.onResults(onResults);

                    cameraUtils = new Camera(videoElement, {
                        onFrame: async () => { await hands.send({image: videoElement}); },
                        width: 640,
                        height: 480,
                        facingMode: 'user'
                    });
                    
                    try {
                        await cameraUtils.start();
                    } catch (e) {
                        setStatus("æ”å½±æ©Ÿæ¬Šé™è¢«æ‹’çµ•");
                        console.error(e);
                    }

                    // --- Animation Loop ---
                    const clock = new THREE.Clock();
                    const animate = () => {
                        animationId = requestAnimationFrame(animate);
                        const time = clock.getElapsedTime();
                        const positions = geometry.attributes.position.array;

                        for (let i = 0; i < particleCount; i++) {
                            const idx = i * 3;
                            positions[idx] += (targetPositions[idx] - positions[idx]) * 0.08;
                            positions[idx+1] += (targetPositions[idx+1] - positions[idx+1]) * 0.08;
                            positions[idx+2] += (targetPositions[idx+2] - positions[idx+2]) * 0.08;
                            positions[idx+1] += Math.sin(time * 2 + positions[idx]) * 0.01;
                        }
                        geometry.attributes.position.needsUpdate = true;

                        particles.rotation.y = time * 0.15;
                        particles.scale.setScalar(handScale);
                        renderer.render(scene, camera);
                    };
                    animate();

                    const handleResize = () => {
                        camera.aspect = window.innerWidth / window.innerHeight;
                        camera.updateProjectionMatrix();
                        renderer.setSize(window.innerWidth, window.innerHeight);
                    };
                    window.addEventListener('resize', handleResize);
                };

                init3D();

                return () => {
                    if (animationId) cancelAnimationFrame(animationId);
                    if (renderer) renderer.dispose();
                    // Cleanup camera utils if possible (library doesn't expose easy stop, but removing element helps)
                };
            }, []);

            return (
                <>
                    {/* é€™è£¡æ”¹ç‚º div */}
                    <div ref={containerRef} className="fixed inset-0 z-[1] pointer-events-none" style={{ background: 'radial-gradient(circle at center, #1a1a2e 0%, #000000 100%)' }} />
                    <video ref={videoRef} id="video-input" playsInline style={{ display: 'none' }}></video>
                    
                    {/* Gesture UI Overlay (Fixed Top Right) */}
                    <div className="fixed top-4 right-4 z-[40] hidden md:flex flex-col gap-2 pointer-events-none">
                        <div id="gesture-feedback-box" className="bg-black/40 backdrop-blur-md border border-white/10 rounded-xl p-3 shadow-lg transition-colors duration-300">
                            <div className="flex items-center justify-between mb-2 pb-2 border-b border-white/10">
                                <span className="text-[10px] text-slate-400 font-bold tracking-widest uppercase">INTERACTIVE BG</span>
                                <div className={`w-2 h-2 rounded-full ${isActive ? 'bg-green-400 shadow-[0_0_8px_#4ade80]' : 'bg-slate-600'}`}></div>
                            </div>
                            <div className="grid grid-cols-2 gap-4 text-xs">
                                <div>
                                    <div className="text-slate-500 scale-75 origin-top-left mb-0.5">GESTURE</div>
                                    <div className="font-mono font-bold text-cyan-400">{gesture}</div>
                                </div>
                                <div>
                                    <div className="text-slate-500 scale-75 origin-top-left mb-0.5">SHAPE</div>
                                    <div className="font-mono font-bold text-pink-400">{currentShape}</div>
                                </div>
                            </div>
                            <div className="mt-2 text-[10px] text-slate-500 text-center">
                                ğŸ– å¼µé–‹æ›å½¢ç‹€ Â· âœŠ æ¡æ‹³æ›è‰²
                            </div>
                        </div>
                    </div>
                </>
            );
        }

        // TodaySchedule Component - å·¦å´èª²è¡¨
        function TodaySchedule({ slots, timetable, now }) {
          const today = now.getDay();
          const todayName = DAYS_ZH[today];
          const currentHour = now.getHours().toString().padStart(2, '0');
          const currentMinute = now.getMinutes().toString().padStart(2, '0');
          const currentTime = `${currentHour}:${currentMinute}`;

          return (
            <div className="hidden lg:block fixed left-4 top-1/2 -translate-y-1/2 z-30 w-56">
              <div className="bg-black/40 backdrop-blur-xl border border-white/10 rounded-2xl p-3 shadow-2xl max-h-[85vh] overflow-y-auto">
                <div className="text-center mb-3 sticky top-0 bg-black/60 backdrop-blur-md py-1.5 rounded-lg -mx-3 px-3">
                  <h3 style={{animation: 'pastel-shift 12s ease-in-out infinite', color: '#ffffff'}} className="text-base font-black mb-0.5">
                    ä»Šæ—¥èª²è¡¨
                  </h3>
                  <p className="text-[10px] text-slate-400">{todayName}</p>
                </div>
                
                <div className="space-y-1.5">
                  {slots.map(slot => {
                    const subject = timetable[today]?.[slot.id] || 'ï¼ˆç©ºå ‚ï¼‰';
                    const isNow = currentTime >= slot.start && currentTime < slot.end;
                    const isPast = currentTime >= slot.end;
                    
                    return (
                      <div 
                        key={slot.id}
                        className={`p-2 rounded-lg border transition-all duration-300 ${
                          isNow 
                            ? 'bg-gradient-to-r from-pink-500/30 to-purple-500/30 border-pink-400 scale-105 shadow-lg shadow-pink-500/30' 
                            : isPast
                            ? 'bg-white/5 border-white/10 opacity-40'
                            : 'bg-white/10 border-white/20'
                        }`}
                      >
                        <div className="flex items-center justify-between mb-0.5">
                          <span className={`font-bold text-[10px] ${isNow ? 'text-pink-300' : 'text-slate-400'}`}>
                            {slot.name}
                          </span>
                          {isNow && (
                            <span className="px-1.5 py-0.5 bg-pink-500 text-white text-[8px] font-black rounded-full animate-pulse">
                              é€²è¡Œä¸­
                            </span>
                          )}
                        </div>
                        
                        <div style={{animation: isNow ? 'pastel-shift 12s ease-in-out infinite' : 'none', color: '#ffffff'}} className={`text-sm font-black mb-0.5`}>
                          {subject}
                        </div>
                        
                        <div className={`text-[9px] ${isNow ? 'text-pink-200' : 'text-slate-500'}`}>
                          {slot.start} - {slot.end}
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
          );
        }

        // RightSchedule Component - å³å´è¡Œäº‹æ›† (æ–°åŠŸèƒ½)
        function RightSchedule({ events, onRefresh, isRefreshing }) {
          // ç°¡å–®è™•ç†æ–‡å­—ï¼Œå°‡æ›è¡Œç¬¦è™Ÿåˆ‡å‰²æˆåˆ—è¡¨
          const eventLines = events ? events.split('\n').filter(line => line.trim() !== '') : [];

          return (
            <div className="hidden lg:block fixed right-4 top-1/2 -translate-y-1/2 z-30 w-64">
              <div className="bg-black/40 backdrop-blur-xl border border-white/10 rounded-2xl p-3 shadow-2xl max-h-[85vh] overflow-y-auto flex flex-col h-full">
                <div className="text-center mb-3 sticky top-0 bg-black/60 backdrop-blur-md py-1.5 rounded-lg -mx-3 px-3 flex items-center justify-between">
                   <div className="flex-1"></div>
                   <div className="text-center flex-1">
                      <h3 style={{animation: 'pastel-shift 12s ease-in-out infinite', color: '#ffffff'}} className="text-base font-black mb-0.5 whitespace-nowrap">
                        è¡Œäº‹æ›†
                      </h3>
                      <p className="text-[10px] text-slate-400">æ ¡å‹™è¡Œç¨‹</p>
                   </div>
                   <div className="flex-1 flex justify-end">
                      <button 
                        onClick={onRefresh} 
                        disabled={isRefreshing}
                        className="w-6 h-6 flex items-center justify-center rounded-full hover:bg-white/10 text-slate-400 transition-colors"
                        title="é‡æ–°æ•´ç†è¡Œäº‹æ›†"
                      >
                         <i className={`fas fa-sync-alt text-[10px] ${isRefreshing ? 'fa-spin text-amber-400' : ''}`}></i>
                      </button>
                   </div>
                </div>
                
                <div className="space-y-2">
                  {isRefreshing ? (
                    <div className="p-4 text-center text-slate-400 text-xs animate-pulse">
                       æ­£åœ¨åŒæ­¥æœ€æ–°è³‡æ–™...
                    </div>
                  ) : eventLines.length === 0 ? (
                    <div className="p-4 text-center bg-white/5 rounded-lg border border-white/10">
                       <span className="text-slate-400 text-sm font-bold">ç„¡</span>
                       <p className="text-[10px] text-slate-500 mt-1">ç›®å‰æ²’æœ‰æ’å®šè¡Œç¨‹</p>
                    </div>
                  ) : (
                    eventLines.map((line, index) => (
                      <div 
                        key={index}
                        className="p-3 rounded-lg border bg-white/10 border-white/20 hover:bg-white/15 transition-all"
                      >
                        <div style={{animation: 'pastel-shift 12s ease-in-out infinite', color: '#ffffff'}} className="text-sm font-bold leading-relaxed whitespace-pre-wrap">
                          {line}
                        </div>
                      </div>
                    ))
                  )}
                </div>
              </div>
            </div>
          );
        }

        // MainDisplay Component
        function MainDisplay({ now, status, broadcast, onCloseBroadcast }) {
          const minguoYear = now.getFullYear() - 1911;
          const dateStr = `æ°‘åœ‹${minguoYear}å¹´${(now.getMonth() + 1).toString().padStart(2, '0')}æœˆ${now.getDate().toString().padStart(2, '0')}æ—¥ ${DAYS_ZH[now.getDay()]}`;
          const timeStr = now.toLocaleTimeString('zh-TW', { hour12: false });

          if (broadcast) {
            return (
              <div className="flex flex-col items-center animate-in zoom-in duration-500 mt-52 px-4">
                <h2 className="text-pink-400 text-3xl font-black uppercase tracking-[0.3em] mb-12 drop-shadow-lg">
                  <i className="fas fa-bullhorn mr-4"></i>
                  ç³»çµ±å»£æ’­ä¸­
                </h2>
                <div style={{animation: 'pastel-shift 12s ease-in-out infinite', color: '#ffffff'}} className="text-[14rem] font-black leading-none text-center drop-shadow-[0_20px_40px_rgba(0,0,0,0.8)]">
                  {broadcast.title}
                </div>
                <div className="text-6xl text-slate-400 font-medium mt-8 tracking-widest text-center">
                  {broadcast.subtitle}
                </div>
                <button 
                  onClick={onCloseBroadcast}
                  className="mt-24 px-16 py-6 bg-white/5 hover:bg-white/10 border border-white/10 rounded-full text-2xl font-bold transition-all btn-3d"
                >
                  é—œé–‰å»£æ’­è¿”å›
                </button>
              </div>
            );
          }

          return (
            <div className="flex flex-col items-center text-center animate-in fade-in duration-1000 px-4 h-full justify-center pb-20">
              <div className="mb-6">
                <div style={{animation: 'pastel-shift 12s ease-in-out infinite', color: '#ffffff'}} className="text-[10rem] font-black leading-tight drop-shadow-[0_15px_30px_rgba(0,0,0,0.5)]">
                  {status.label}
                </div>
              </div>

              <div style={{animation: 'pastel-shift 12s ease-in-out infinite', color: '#ffffff'}} className="text-[18rem] font-mono font-bold tracking-tighter leading-none mb-12 drop-shadow-[0_30px_60px_rgba(0,0,0,0.7)]">
                {timeStr}
              </div>

              <div className="text-5xl text-slate-500 font-light tracking-widest px-12 py-4 bg-white/2 rounded-full border border-white/5">
                {dateStr}
              </div>
            </div>
          );
        }

        // Toolbar Component
        function Toolbar({ onOpenBroadcast, onOpenSettings, onOpenTravel, onQuickAction }) {
          const [isFullScreen, setIsFullScreen] = useState(false);

          useEffect(() => {
            const handleFullScreenChange = () => {
              setIsFullScreen(!!document.fullscreenElement);
            };

            document.addEventListener('fullscreenchange', handleFullScreenChange);
            document.addEventListener('webkitfullscreenchange', handleFullScreenChange);
            document.addEventListener('mozfullscreenchange', handleFullScreenChange);
            document.addEventListener('MSFullscreenChange', handleFullScreenChange);

            return () => {
              document.removeEventListener('fullscreenchange', handleFullScreenChange);
              document.removeEventListener('webkitfullscreenchange', handleFullScreenChange);
              document.removeEventListener('mozfullscreenchange', handleFullScreenChange);
              document.removeEventListener('MSFullscreenChange', handleFullScreenChange);
            };
          }, []);

          const toggleFullScreen = () => {
            if (!document.fullscreenElement) {
              document.documentElement.requestFullscreen().catch((err) => {
                console.error(`Error attempting to enable full-screen mode: ${err.message}`);
              });
            } else {
              if (document.exitFullscreen) {
                document.exitFullscreen();
              }
            }
          };

          return (
            <div className="p-4 md:p-8 glass-texture border-t border-white/10 relative z-20">
              {/* ä¸»è¦æŒ‰éˆ•å€åŸŸ */}
              <div className="flex flex-col md:flex-row items-center justify-center gap-3 md:gap-4 mb-3 md:mb-0">
                <button 
                    onClick={onOpenBroadcast}
                    className="w-full md:w-auto px-6 md:px-8 h-14 md:h-16 bg-gradient-to-b from-pink-400 to-pink-600 rounded-2xl flex items-center justify-center gap-2 md:gap-3 transition-all btn-3d font-black shadow-pink-900/40"
                >
                  <i className="fas fa-bullhorn text-lg md:text-xl"></i>
                  <span className="text-base md:text-lg">è‡ªè¨‚å»£æ’­</span>
                </button>

                <div className="w-full md:w-auto grid grid-cols-2 md:flex gap-2 md:gap-4">
                  <button 
                      onClick={() => onQuickAction("å»ä¸Šèª²äº†", "ä¸‹èª²æ‰å›ä¾†")}
                      className="px-4 md:px-6 h-14 md:h-16 bg-gradient-to-b from-blue-500 to-blue-700 rounded-2xl flex flex-col items-center justify-center transition-all btn-3d font-black shadow-blue-900/40"
                  >
                    <div className="flex items-center gap-2">
                      <i className="fas fa-person-walking-arrow-right text-sm md:text-lg"></i>
                      <span className="text-sm md:text-base">å»ä¸Šèª²äº†</span>
                    </div>
                    <span className="text-[9px] md:text-[10px] opacity-70 font-normal">ä¸‹èª²æ‰å›ä¾†</span>
                  </button>

                  <button 
                      onClick={() => onQuickAction("å›å®¶äº†", "æ˜å¤©æ‰å›ä¾†")}
                      className="px-4 md:px-6 h-14 md:h-16 bg-gradient-to-b from-orange-500 to-orange-700 rounded-2xl flex flex-col items-center justify-center transition-all btn-3d font-black shadow-orange-900/40"
                  >
                    <div className="flex items-center gap-2">
                      <i className="fas fa-house-chimney text-sm md:text-lg"></i>
                      <span className="text-sm md:text-base">å›å®¶äº†</span>
                    </div>
                    <span className="text-[9px] md:text-[10px] opacity-70 font-normal">æ˜å¤©æ‰å›ä¾†</span>
                  </button>

                  <button 
                      onClick={() => onQuickAction("æ‰“çƒå»äº†", "ä¸‹åˆæ‰å›ä¾†")}
                      className="px-4 md:px-6 h-14 md:h-16 bg-gradient-to-b from-emerald-500 to-emerald-700 rounded-2xl flex flex-col items-center justify-center transition-all btn-3d font-black shadow-emerald-900/40"
                  >
                    <div className="flex items-center gap-2">
                      <i className="fas fa-basketball text-sm md:text-lg"></i>
                      <span className="text-sm md:text-base">æ‰“çƒå»äº†</span>
                    </div>
                    <span className="text-[9px] md:text-[10px] opacity-70 font-normal">ä¸‹åˆæ‰å›ä¾†</span>
                  </button>

                  <button 
                      onClick={() => onQuickAction("é–‹æœƒå»äº†", "è«‹ç¨å¾Œå†ä¾†è¨ª")}
                      className="px-4 md:px-6 h-14 md:h-16 bg-gradient-to-b from-violet-500 to-violet-700 rounded-2xl flex flex-col items-center justify-center transition-all btn-3d font-black shadow-violet-900/40"
                  >
                    <div className="flex items-center gap-2">
                      <i className="fas fa-users-rectangle text-sm md:text-lg"></i>
                      <span className="text-sm md:text-base">é–‹æœƒå»äº†</span>
                    </div>
                    <span className="text-[9px] md:text-[10px] opacity-70 font-normal">è«‹ç¨å¾Œå†ä¾†è¨ª</span>
                  </button>
                </div>

                <button 
                    onClick={onOpenTravel}
                    className="w-full md:w-auto px-6 md:px-8 h-14 md:h-16 bg-gradient-to-b from-indigo-500 to-indigo-700 rounded-2xl flex items-center justify-center gap-2 md:gap-3 transition-all btn-3d font-black shadow-indigo-900/40 border border-indigo-400/20"
                >
                  <i className="fas fa-plane-departure text-lg md:text-xl"></i>
                  <span className="text-base md:text-lg">å‡ºåœ‹äº†</span>
                </button>
              </div>

              {/* è¨­å®šæŒ‰éˆ•å€åŸŸ */}
              <div className="flex items-center justify-center md:justify-end gap-3 md:gap-4 mt-3 md:mt-0 md:absolute md:right-8 md:top-1/2 md:-translate-y-1/2">
                <button 
                    onClick={toggleFullScreen}
                    title={isFullScreen ? "é€€å‡ºå…¨è¢å¹•" : "é€²å…¥å…¨è¢å¹•"}
                    className="w-12 h-12 md:w-14 md:h-14 flex items-center justify-center hover:bg-white/10 rounded-full transition-all border border-white/5 bg-white/2"
                >
                    <i className={`fas ${isFullScreen ? 'fa-compress' : 'fa-expand'} text-xl md:text-2xl text-slate-400`}></i>
                </button>
                <button 
                    onClick={onOpenSettings}
                    title="ç³»çµ±è¨­å®š"
                    className="w-12 h-12 md:w-14 md:h-14 flex items-center justify-center hover:bg-white/10 rounded-full transition-all border border-white/5 bg-white/2"
                >
                    <i className="fas fa-gear text-xl md:text-2xl text-slate-400"></i>
                </button>
              </div>
            </div>
          );
        }

        // BroadcastModal Component
        function BroadcastModal({ templates, onUpdateTemplates, onPublish, onClose }) {
          const [activeTab, setActiveTab] = useState(templates[0].id);
          const current = templates.find(t => t.id === activeTab);

          const handleChange = (field, val) => {
            onUpdateTemplates(templates.map(t => t.id === activeTab ? { ...t, [field]: val } : t));
          };

          return (
            <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm p-2 md:p-4 animate-in fade-in duration-200">
              <div className="bg-white rounded-2xl md:rounded-[2rem] w-full max-w-xl max-h-[90vh] overflow-y-auto text-slate-800 shadow-2xl flex flex-col animate-in slide-in-from-bottom-8 duration-300">
                <div className="p-4 md:p-6 border-b flex items-center justify-between sticky top-0 bg-white z-10">
                  <h2 className="text-lg md:text-2xl font-bold flex items-center gap-2 md:gap-3">
                    <i className="fas fa-bullhorn text-pink-500"></i>
                    ç™¼å¸ƒè‡ªè¨‚å»£æ’­
                  </h2>
                  <button onClick={onClose} className="text-slate-400 hover:text-slate-600 text-xl md:text-2xl">
                    <i className="fas fa-times"></i>
                  </button>
                </div>

                <div className="p-4 md:p-8 space-y-4 md:space-y-6">
                  <div className="flex bg-slate-100 p-1 rounded-xl md:rounded-2xl">
                    {templates.map(t => (
                      <button
                        key={t.id}
                        onClick={() => setActiveTab(t.id)}
                        className={`flex-1 py-2 md:py-3 text-sm md:text-base font-bold rounded-lg md:rounded-xl transition-all ${
                          activeTab === t.id ? 'bg-white text-pink-500 shadow-sm' : 'text-slate-400'
                        }`}
                      >
                        {t.btnName}
                      </button>
                    ))}
                  </div>

                  <div className="space-y-3 md:space-y-4">
                    <div>
                      <label className="block text-xs md:text-sm font-bold text-slate-400 mb-2">æŒ‰éˆ•åç¨± <i className="fas fa-pen text-[10px] ml-1"></i></label>
                      <input 
                        value={current.btnName} 
                        onChange={e => handleChange('btnName', e.target.value)}
                        className="w-full px-4 md:px-5 py-2 md:py-3 text-sm md:text-base bg-slate-50 border rounded-xl md:rounded-2xl outline-none focus:ring-2 focus:ring-pink-400 transition-all"
                      />
                    </div>
                    <div>
                      <label className="block text-xs md:text-sm font-bold text-slate-400 mb-2">ä¸»æ¨™é¡Œ</label>
                      <input 
                        value={current.title} 
                        onChange={e => handleChange('title', e.target.value)}
                        placeholder="ä¾‹å¦‚ï¼šå…¨ç­é›†åˆ"
                        className="w-full px-4 md:px-5 py-3 md:py-4 bg-slate-50 border rounded-xl md:rounded-2xl text-lg md:text-2xl font-bold outline-none focus:ring-2 focus:ring-pink-400"
                      />
                    </div>
                    <div>
                      <label className="block text-xs md:text-sm font-bold text-slate-400 mb-2">å‰¯æ¨™é¡Œ</label>
                      <input 
                        value={current.subtitle} 
                        onChange={e => handleChange('subtitle', e.target.value)}
                        placeholder="ä¾‹å¦‚ï¼šè«‹åˆ°èµ°å»Šæ’éšŠ"
                        className="w-full px-4 md:px-5 py-2 md:py-3 text-sm md:text-base bg-slate-50 border rounded-xl md:rounded-2xl outline-none focus:ring-2 focus:ring-pink-400"
                      />
                    </div>
                  </div>

                  <div className="bg-slate-50 rounded-xl md:rounded-2xl p-4 md:p-6 text-center border border-slate-100">
                    <p className="text-[10px] font-bold text-slate-300 uppercase tracking-widest mb-2">ç•«é¢é è¦½</p>
                    <div className="text-2xl md:text-3xl font-bold text-slate-800 mb-1">{current.title || 'ï¼ˆæœªè¼¸å…¥ï¼‰'}</div>
                    <div className="text-xs md:text-sm text-slate-400">{current.subtitle || 'ï¼ˆæœªè¼¸å…¥ï¼‰'}</div>
                  </div>
                </div>

                <div className="p-4 md:p-6 bg-slate-50 border-t flex items-center justify-end gap-3 md:gap-4 sticky bottom-0">
                  <button onClick={onClose} className="px-6 md:px-8 py-2 md:py-3 text-sm md:text-base font-bold text-slate-500 hover:text-slate-700">å–æ¶ˆ</button>
                  <button 
                    onClick={() => onPublish(current)}
                    className="px-8 md:px-10 py-2 md:py-3 text-sm md:text-base bg-pink-500 hover:bg-pink-600 text-white font-bold rounded-xl md:rounded-2xl shadow-lg shadow-pink-200 transition-all active:scale-95"
                  >
                    ç™¼å¸ƒå»£æ’­
                  </button>
                </div>
              </div>
            </div>
          );
        }

        // TravelModal Component
        function TravelModal({ onPublish, onClose }) {
          const travelOptions = [
            { name: "å¾·åœ‹", icon: "fa-castle" },
            { name: "æ—¥æœ¬", icon: "fa-torii-gate" },
            { name: "æ¾³æ´²", icon: "fa-kangaroo" },
            { name: "ç¾åœ‹", icon: "fa-flag-usa" }
          ];
          const [custom, setCustom] = useState("");

          return (
            <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-xl p-2 md:p-4 animate-in fade-in duration-300">
              <div className="bg-slate-900/95 border border-white/10 rounded-2xl md:rounded-[3rem] w-full max-w-xl max-h-[90vh] overflow-y-auto p-6 md:p-10 shadow-2xl animate-in zoom-in-95">
                <div className="flex justify-between items-center mb-6 md:mb-10">
                    <h2 className="text-2xl md:text-3xl font-black flex items-center gap-3 md:gap-4 text-indigo-400">
                        <i className="fas fa-globe-americas"></i>
                        é¸æ“‡ç›®çš„åœ°
                    </h2>
                    <button onClick={onClose} className="text-slate-500 hover:text-white transition-colors text-2xl md:text-3xl">
                        <i className="fas fa-times"></i>
                    </button>
                </div>

                <div className="grid grid-cols-2 gap-3 md:gap-5 mb-6 md:mb-10">
                    {travelOptions.map(opt => (
                        <button
                            key={opt.name}
                            onClick={() => onPublish(opt.name)}
                            className="p-6 md:p-8 rounded-2xl md:rounded-3xl bg-white/5 border border-white/10 hover:bg-indigo-600/40 hover:border-indigo-400 transition-all font-bold text-xl md:text-2xl btn-3d flex flex-col items-center gap-2 md:gap-3"
                        >
                            <i className={`fas ${opt.icon} text-2xl md:text-3xl text-indigo-300`}></i>
                            {opt.name}
                        </button>
                    ))}
                </div>

                <div className="space-y-3 md:space-y-4">
                    <label className="text-[10px] md:text-xs font-bold text-slate-500 uppercase tracking-widest px-2 block">æˆ–è‡ªè¡Œè¼¸å…¥ç›®çš„åœ°</label>
                    <div className="relative flex items-center">
                        <input 
                            value={custom}
                            onChange={e => setCustom(e.target.value)}
                            placeholder="è¼¸å…¥åœ‹å®¶æˆ–åŸå¸‚..."
                            className="w-full px-6 md:px-8 py-4 md:py-5 text-base md:text-xl bg-white/5 border border-white/10 rounded-2xl md:rounded-3xl outline-none focus:ring-2 focus:ring-indigo-500 transition-all pr-24 md:pr-32"
                        />
                        <button 
                            disabled={!custom.trim()}
                            onClick={() => onPublish(custom)}
                            className="absolute right-2 top-2 bottom-2 px-6 md:px-8 text-sm md:text-base bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl md:rounded-2xl font-bold disabled:opacity-30 transition-all active:scale-95"
                        >
                            ç¢ºå®š
                        </button>
                    </div>
                </div>
              </div>
            </div>
          );
        }

        // SettingsModal Component
        function SettingsModal({ slots, setSlots, timetable, setTimetable, lastSyncTime, onSync, onClose }) {
          const [activeSection, setActiveSection] = useState('timetable');
          const [isSyncingLocal, setIsSyncingLocal] = useState(false);
          const [isImporting, setIsImporting] = useState(false);
          const fileInputRef = useRef(null);

          const handleTimetableChange = (day, slotId, value) => {
            setTimetable({
              ...timetable,
              [day]: { ...(timetable[day] || {}), [slotId]: value }
            });
          };

          const handleGoogleSync = async () => {
            setIsSyncingLocal(true);
            await onSync();
            setIsSyncingLocal(false);
            setActiveSection('timetable');
          };

          const handleFileChange = async (event) => {
            const file = event.target.files?.[0];
            if (!file) return;

            setIsImporting(true);
            try {
              const arrayBuffer = await file.arrayBuffer();
              const data = new Uint8Array(arrayBuffer);
              const workbook = XLSX.read(data, { type: 'array' });
              const firstSheetName = workbook.SheetNames[0];
              const worksheet = workbook.Sheets[firstSheetName];
              const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

              const newSlots = [];
              const newTimetable = {};
              const dataRows = json.slice(1);
              
              dataRows.forEach((row, rowIndex) => {
                if (!row || row.length === 0) return;
                
                const slotRaw = String(row[0] || '').replace(/\s/g, '');
                if (!slotRaw) return;

                const timeMatch = slotRaw.match(/(\d{1,2}[:ï¼š]\d{2})\s*[~ï½-]\s*(\d{1,2}[:ï¼š]\d{2})/);
                const nameMatch = slotRaw.match(/^[^\d]+/);
                const slotName = nameMatch ? nameMatch[0] : `ç¬¬${rowIndex + 1}ç¯€`;
                const startTime = timeMatch ? timeMatch[1].replace('ï¼š', ':').padStart(5, '0') : '00:00';
                const endTime = timeMatch ? timeMatch[2].replace('ï¼š', ':').padStart(5, '0') : '00:00';
                
                const slotId = (rowIndex + 1).toString();
                newSlots.push({ id: slotId, name: slotName, start: startTime, end: endTime });

                for (let day = 0; day < 7; day++) {
                  const subject = row[day + 1];
                  if (subject) {
                    if (!newTimetable[day]) newTimetable[day] = {};
                    newTimetable[day][slotId] = String(subject).trim();
                  }
                }
              });

              if (newSlots.length > 0) {
                setSlots(newSlots);
                setTimetable(newTimetable);
                setActiveSection('timetable');
                alert(`åŒ¯å…¥æˆåŠŸï¼å·²è®€å– ${newSlots.length} ç¯€èª²è¡¨å…§å®¹ã€‚`);
              }
            } catch (error) {
              alert('æª”æ¡ˆè®€å–å¤±æ•—ï¼š' + error.message);
            } finally {
              setIsImporting(false);
              if (fileInputRef.current) fileInputRef.current.value = '';
            }
          };

          const triggerFileInput = () => fileInputRef.current?.click();

          const sections = [
            { id: 'schedule', title: 'ä½œæ¯æ™‚é–“è¡¨è¨­å®š', icon: 'fa-clock' },
            { id: 'timetable', title: 'èª²è¡¨è¨­å®š', icon: 'fa-book' },
            { id: 'system', title: 'é›²ç«¯åŒæ­¥èˆ‡åŒ¯å…¥', icon: 'fa-cloud-arrow-down' },
          ];

          return (
            <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/70 backdrop-blur-md p-2 md:p-4 animate-in fade-in duration-200">
              <div className="bg-[#f8fafc] rounded-xl md:rounded-[2rem] w-full max-w-[98vw] lg:max-w-6xl max-h-[95vh] md:max-h-[92vh] text-slate-800 overflow-hidden shadow-2xl flex flex-col animate-in zoom-in-95 duration-300">
                <div className="p-4 md:p-6 bg-white border-b flex items-center justify-between sticky top-0 z-10">
                  <h2 className="text-lg md:text-2xl font-bold flex items-center gap-2 md:gap-3">
                    <i className="fas fa-gear text-slate-700"></i>
                    è¨­å®šæ§åˆ¶å°
                  </h2>
                  <button onClick={onClose} className="text-slate-400 hover:text-slate-600 text-xl md:text-2xl">
                    <i className="fas fa-times"></i>
                  </button>
                </div>

                <div className="flex-grow overflow-y-auto p-3 md:p-6 space-y-3 md:space-y-4">
                  {sections.map(sec => (
                    <div key={sec.id} className="bg-white border border-slate-200 rounded-xl md:rounded-2xl overflow-hidden shadow-sm">
                      <button 
                        onClick={() => setActiveSection(activeSection === sec.id ? null : sec.id)}
                        className="w-full px-4 md:px-8 py-4 md:py-5 flex items-center justify-between hover:bg-slate-50 transition-all"
                      >
                        <div className="flex items-center gap-3 md:gap-4">
                            <i className={`fas ${sec.icon} ${activeSection === sec.id ? 'text-blue-500' : 'text-slate-400'} text-lg md:text-xl`}></i>
                            <span className="font-bold text-base md:text-lg">{sec.title}</span>
                        </div>
                        <i className={`fas fa-chevron-${activeSection === sec.id ? 'up' : 'down'} text-slate-300`}></i>
                      </button>

                      {activeSection === sec.id && (
                        <div className="p-3 md:p-8 border-t bg-slate-50/50 animate-in slide-in-from-top-2">
                          {sec.id === 'timetable' && (
                            <div>
                              {lastSyncTime && (
                                <div className="mb-3 md:mb-4 p-3 md:p-4 bg-green-50 border border-green-200 rounded-lg md:rounded-xl flex items-center gap-2 md:gap-3">
                                  <i className="fas fa-check-circle text-green-600 text-lg md:text-xl"></i>
                                  <div className="text-xs md:text-sm text-green-800">
                                    <span className="font-bold">å·²åŒæ­¥ Google è©¦ç®—è¡¨</span>
                                    <span className="text-green-600 ml-2 hidden md:inline">({lastSyncTime})</span>
                                  </div>
                                </div>
                              )}
                              <div className="overflow-x-auto pb-4 -mx-3 md:mx-0">
                              <div className="min-w-[800px] px-3 md:px-0">
                              <table className="w-full border-separate border-spacing-x-2 md:border-spacing-x-3 border-spacing-y-2">
                                <thead>
                                  <tr className="text-slate-400 text-xs md:text-sm font-bold">
                                    <th className="w-16 md:w-20 py-2">ç¯€æ¬¡</th>
                                    {DAYS_ZH.map(d => <th key={d} className="min-w-[100px] md:min-w-[120px] py-2">{d}</th>)}
                                  </tr>
                                </thead>
                                <tbody>
                                  {slots.map(slot => (
                                    <tr key={slot.id}>
                                      <td className="text-center">
                                        <div className="px-2 md:px-3 py-2 bg-white border border-slate-200 rounded-lg md:rounded-xl text-slate-500 font-bold text-xs md:text-sm shadow-sm">
                                            {slot.name}
                                        </div>
                                      </td>
                                      {[0, 1, 2, 3, 4, 5, 6].map(day => (
                                        <td key={day}>
                                          <input 
                                            className="w-full px-2 md:px-4 py-2 md:py-3 bg-white border border-slate-200 rounded-lg md:rounded-2xl outline-none focus:ring-2 focus:ring-blue-400 text-sm md:text-base font-medium transition-all text-center shadow-sm placeholder:text-slate-200"
                                            value={timetable[day]?.[slot.id] || ''}
                                            onChange={e => handleTimetableChange(day, slot.id, e.target.value)}
                                          />
                                        </td>
                                      ))}
                                    </tr>
                                  ))}
                                </tbody>
                              </table>
                            </div>
                            </div>
                            </div>
                          )}
                          {sec.id === 'schedule' && (
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4">
                                {slots.map(slot => (
                                    <div key={slot.id} className="bg-white p-4 md:p-5 border border-slate-200 rounded-2xl md:rounded-3xl flex flex-col gap-2 md:gap-3 shadow-sm">
                                        <span className="font-black text-slate-400 text-[10px] md:text-xs uppercase tracking-widest">{slot.name}</span>
                                        <div className="flex items-center gap-2">
                                            <input type="time" className="flex-1 p-2 text-sm md:text-base bg-slate-50 border border-slate-100 rounded-lg md:rounded-xl text-center font-bold" value={slot.start} onChange={e => setSlots(slots.map(s => s.id === slot.id ? {...s, start: e.target.value} : s))} />
                                            <span className="text-slate-300">~</span>
                                            <input type="time" className="flex-1 p-2 text-sm md:text-base bg-slate-50 border border-slate-100 rounded-lg md:rounded-xl text-center font-bold" value={slot.end} onChange={e => setSlots(slots.map(s => s.id === slot.id ? {...s, end: e.target.value} : s))} />
                                        </div>
                                    </div>
                                ))}
                            </div>
                          )}
                          {sec.id === 'system' && (
                            <div className="space-y-4 md:space-y-6">
                                <div className="bg-gradient-to-br from-blue-500 to-indigo-600 p-6 md:p-8 rounded-xl md:rounded-[2rem] text-white flex flex-col gap-4 md:gap-6 shadow-xl shadow-blue-200">
                                    <div className="flex items-center gap-4 md:gap-6 flex-1">
                                        <div className="w-12 h-12 md:w-16 md:h-16 bg-white/20 rounded-2xl md:rounded-3xl flex items-center justify-center text-white flex-shrink-0">
                                            <i className="fas fa-sync-alt text-xl md:text-2xl"></i>
                                        </div>
                                        <div className="flex-1">
                                            <h4 className="font-black text-lg md:text-xl">åŒæ­¥ Google è©¦ç®—è¡¨</h4>
                                            <p className="text-blue-100 text-sm md:text-base mt-1">ç›´æ¥å¾æ‚¨çš„ç·šä¸Š Google è©¦ç®—è¡¨è®€å–æœ€æ–°èª²è¡¨ã€‚</p>
                                            {lastSyncTime && (
                                              <p className="text-blue-200 text-xs md:text-sm mt-2">
                                                <i className="fas fa-clock mr-2"></i>
                                                ä¸Šæ¬¡åŒæ­¥: {lastSyncTime}
                                              </p>
                                            )}
                                        </div>
                                    </div>
                                    <button 
                                        onClick={handleGoogleSync}
                                        disabled={isSyncingLocal}
                                        className={`w-full md:w-auto px-8 md:px-10 py-3 md:py-4 bg-white text-blue-600 font-black rounded-xl md:rounded-2xl transition-all shadow-lg hover:scale-105 active:scale-95 ${isSyncingLocal ? 'opacity-50' : ''}`}
                                    >
                                        {isSyncingLocal ? 'åŒæ­¥ä¸­...' : 'ç«‹å³åŒæ­¥'}
                                    </button>
                                </div>

                                <div className="bg-white p-6 md:p-8 rounded-xl md:rounded-[2rem] border border-slate-200 flex flex-col gap-4 md:gap-6 shadow-sm">
                                    <div className="flex items-center gap-4 md:gap-6 flex-1">
                                        <div className="w-12 h-12 md:w-16 md:h-16 bg-slate-100 rounded-2xl md:rounded-3xl flex items-center justify-center text-slate-600 shadow-inner flex-shrink-0">
                                            <i className="fas fa-file-excel text-xl md:text-2xl"></i>
                                        </div>
                                        <div className="flex-1">
                                            <h4 className="font-black text-lg md:text-xl text-slate-700">é›¢ç·šåŒ¯å…¥ Excel</h4>
                                            <p className="text-slate-400 text-sm md:text-base mt-1">æ‰‹å‹•ä¸Šå‚³ .xlsx æª”æ¡ˆä¾†æ›´æ–°èª²è¡¨ã€‚</p>
                                        </div>
                                    </div>
                                    <input type="file" ref={fileInputRef} onChange={handleFileChange} accept=".xlsx" className="hidden" />
                                    <button onClick={triggerFileInput} disabled={isImporting} className="w-full md:w-auto px-8 md:px-10 py-3 md:py-4 bg-slate-100 hover:bg-slate-200 text-slate-700 font-black rounded-xl md:rounded-2xl transition-all flex items-center justify-center gap-3 active:scale-95">
                                        <i className={`fas ${isImporting ? 'fa-spinner fa-spin' : 'fa-folder-open'} text-lg md:text-xl`}></i>
                                        {isImporting ? 'è™•ç†ä¸­...' : 'é¸å–æª”æ¡ˆ'}
                                    </button>
                                </div>
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  ))}
                </div>

                <div className="p-4 md:p-6 bg-white border-t flex items-center justify-end sticky bottom-0">
                  <button onClick={onClose} className="w-full md:w-auto px-12 md:px-16 py-3 md:py-4 text-sm md:text-base bg-[#0f172a] hover:bg-slate-800 text-white font-black rounded-xl md:rounded-2xl shadow-xl transition-all active:scale-95">
                    å„²å­˜ä¸¦é—œé–‰
                  </button>
                </div>
              </div>
            </div>
          );
        }

        // Main App Component
        function App() {
          const [now, setNow] = useState(new Date());
          const [isSyncing, setIsSyncing] = useState(false);
          const [isRefreshingCalendar, setIsRefreshingCalendar] = useState(false);
          const [calendarEvents, setCalendarEvents] = useState(''); // åˆå§‹åŒ–ç‚ºç©ºå­—ä¸²ï¼Œç­‰å¾…è³‡æ–™
          
          const isFetchingRef = useRef(false);

          const [slots, setSlots] = useState(() => {
            const saved = localStorage.getItem('slots');
            return saved ? JSON.parse(saved) : DEFAULT_SLOTS;
          });

          const [timetable, setTimetable] = useState(() => {
            const saved = localStorage.getItem('timetable');
            return saved ? JSON.parse(saved) : {};
          });

          const [lastSyncTime, setLastSyncTime] = useState(() => {
            return localStorage.getItem('lastSyncTime') || null;
          });

          const [templates, setTemplates] = useState(() => {
            const saved = localStorage.getItem('templates');
            return saved ? JSON.parse(saved) : DEFAULT_TEMPLATES;
          });

          const [broadcast, setBroadcast] = useState(null);
          const [isBroadcastModalOpen, setIsBroadcastModalOpen] = useState(false);
          const [isSettingsModalOpen, setIsSettingsModalOpen] = useState(false);
          const [isTravelModalOpen, setIsTravelModalOpen] = useState(false);
          const [showCorsWarning, setShowCorsWarning] = useState(false);

          const fetchCalendarEvents = useCallback(async () => {
            if (isFetchingRef.current) return;
            
            isFetchingRef.current = true;
            setIsRefreshingCalendar(true);

            try {
              const response = await fetch(N8N_WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                  action: "query_calendar", 
                  query: "è«‹æŸ¥è©¢æˆ‘çš„è¡Œäº‹æ›†ï¼Œçµ¦æˆ‘ä»Šå¤©ã€æ˜å¤©èˆ‡å¾Œå¤©çš„å…¨éƒ¨è¡Œç¨‹ã€‚è¼¸å‡ºçš„çµæœè«‹å‹™å¿…åŒ…å«ä»Šæ—¥ã€æ˜æ—¥èˆ‡å¾Œå¤©ï¼Œä¸¦é©ç•¶æ›è¡Œå‘ˆç¾ã€‚",
                  time: new Date().toISOString() 
                }),
                mode: 'cors',
                cache: 'no-cache'
              });
              
              if (!response.ok) {
                throw new Error(`ä¼ºæœå™¨å›æ‡‰éŒ¯èª¤: ${response.status}`);
              }
              
              const data = await response.json();
              
              let result = "";
              if (typeof data === 'string') {
                result = data;
              } else if (Array.isArray(data)) {
                const first = data[0];
                result = first.output || first.text || first.message || JSON.stringify(first);
              } else if (data) {
                result = data.output || data.text || data.message || data.result || JSON.stringify(data);
              }
              
              setCalendarEvents(result);
            } catch (error) {
              console.error("è¡Œäº‹æ›†ç²å–å¤±æ•—:", error);
              setCalendarEvents("ç„¡æ³•é€£ç·šè‡³è¡Œäº‹æ›†ç³»çµ±ã€‚");
            } finally {
              setIsRefreshingCalendar(false);
              isFetchingRef.current = false;
            }
          }, []);

          const syncWithGoogleSheet = useCallback(async (silent = false) => {
            setIsSyncing(true);
            try {
              // å…ˆå˜—è©¦ç›´æ¥é€£æ¥ï¼Œå¦‚æœå¤±æ•—å‰‡ä½¿ç”¨ CORS proxy
              let response;
              let csvText;
              
              try {
                response = await fetch(SHEET_URL);
                if (!response.ok) throw new Error("ç›´æ¥é€£æ¥å¤±æ•—");
                csvText = await response.text();
              } catch (firstError) {
                console.log("ç›´æ¥é€£æ¥å¤±æ•—ï¼Œå˜—è©¦ä½¿ç”¨ CORS proxy...");
                // ä½¿ç”¨ CORS proxy ä½œç‚ºå‚™ç”¨æ–¹æ¡ˆ
                const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(SHEET_URL)}`;
                response = await fetch(proxyUrl);
                if (!response.ok) throw new Error("ç„¡æ³•æŠ“å–è©¦ç®—è¡¨å…§å®¹");
                csvText = await response.text();
              }
              
              // æª¢æŸ¥æ˜¯å¦çœŸçš„æœ‰å…§å®¹
              if (!csvText || csvText.trim().length === 0) {
                throw new Error("è©¦ç®—è¡¨å…§å®¹ç‚ºç©º");
              }
              
              const workbook = XLSX.read(csvText, { type: 'string' });
              const firstSheetName = workbook.SheetNames[0];
              const worksheet = workbook.Sheets[firstSheetName];
              const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

              const newSlots = [];
              const newTimetable = {};
              const dataRows = json.slice(1);
              
              dataRows.forEach((row, rowIndex) => {
                if (!row || row.length === 0) return;
                const slotRaw = String(row[0] || '').replace(/\s/g, '');
                if (!slotRaw) return;

                const timeMatch = slotRaw.match(/(\d{1,2}[:ï¼š]\d{2})\s*[~ï½-]\s*(\d{1,2}[:ï¼š]\d{2})/);
                const nameMatch = slotRaw.match(/^[^\d]+/);
                const slotName = nameMatch ? nameMatch[0] : `ç¬¬${rowIndex + 1}ç¯€`;
                const startTime = timeMatch ? timeMatch[1].replace('ï¼š', ':').padStart(5, '0') : '00:00';
                const endTime = timeMatch ? timeMatch[2].replace('ï¼š', ':').padStart(5, '0') : '00:00';
                
                const slotId = (rowIndex + 1).toString();
                newSlots.push({ id: slotId, name: slotName, start: startTime, end: endTime });

                for (let day = 0; day < 7; day++) {
                  const subject = row[day + 1];
                  if (subject) {
                    if (!newTimetable[day]) newTimetable[day] = {};
                    newTimetable[day][slotId] = String(subject).trim();
                  }
                }
              });

              if (newSlots.length > 0) {
                setSlots(newSlots);
                setTimetable(newTimetable);
                const syncTime = new Date().toLocaleString('zh-TW');
                setLastSyncTime(syncTime);
                localStorage.setItem('lastSyncTime', syncTime);
                if (!silent) {
                  alert(`âœ… åŒæ­¥æˆåŠŸï¼\n\nå·²æ›´æ–° ${newSlots.length} å€‹æ™‚æ®µçš„èª²è¡¨è³‡æ–™ã€‚\nè«‹è‡³ã€Œèª²è¡¨è¨­å®šã€æŸ¥çœ‹åŒæ­¥å¾Œçš„å…§å®¹ã€‚`);
                }
                console.log(`Google Sheet åŒæ­¥æˆåŠŸ: ${newSlots.length} å€‹æ™‚æ®µå·²æ›´æ–°`);
              } else {
                throw new Error("è©¦ç®—è¡¨ä¸­æ²’æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„èª²è¡¨è³‡æ–™");
              }
            } catch (error) {
              console.error("åŒæ­¥å¤±æ•—:", error);
              if (!silent) {
                let errorMessage = `âŒ åŒæ­¥å¤±æ•—\n\néŒ¯èª¤è¨Šæ¯: ${error.message}\n\n`;
                
                if (error.message.includes("Failed to fetch")) {
                  errorMessage += `é€™æ˜¯ CORS éŒ¯èª¤ï¼Œé€šå¸¸ç™¼ç”Ÿåœ¨ç›´æ¥é–‹å•Ÿ HTML æª”æ¡ˆæ™‚ã€‚\n\nè§£æ±ºæ–¹æ¡ˆï¼š\n`;
                  errorMessage += `1. ä½¿ç”¨æœ¬æ©Ÿä¼ºæœå™¨ï¼ˆæ¨è–¦ï¼‰\n`;
                  errorMessage += `   - Python: python -m http.server 8000\n`;
                  errorMessage += `   - ç„¶å¾Œé–‹å•Ÿ http://localhost:8000/classroom-tool.html\n\n`;
                  errorMessage += `2. æˆ–ä¸Šå‚³åˆ°ç¶²ç«™ç©ºé–“ä½¿ç”¨\n\n`;
                  errorMessage += `3. æª¢æŸ¥ Google è©¦ç®—è¡¨æ¬Šé™è¨­å®š`;
                } else {
                  errorMessage += `è«‹ç¢ºèª:\n`;
                  errorMessage += `1. Google è©¦ç®—è¡¨é€£çµæ˜¯å¦æ­£ç¢º\n`;
                  errorMessage += `2. è©¦ç®—è¡¨æ˜¯å¦è¨­ç‚ºã€ŒçŸ¥é“é€£çµçš„ä½¿ç”¨è€…å¯ä»¥æª¢è¦–ã€\n`;
                  errorMessage += `3. è©¦ç®—è¡¨æ ¼å¼æ˜¯å¦ç¬¦åˆè¦æ±‚`;
                }
                
                alert(errorMessage);
              }
            } finally {
              setIsSyncing(false);
            }
          }, []);

          useEffect(() => {
            // æª¢æŸ¥æ˜¯å¦ä½¿ç”¨ file:// å”è­°é–‹å•Ÿ
            if (window.location.protocol === 'file:') {
              setShowCorsWarning(true);
              console.warn('âš ï¸ æª¢æ¸¬åˆ°ä½¿ç”¨ file:// å”è­°é–‹å•Ÿã€‚Google Sheet åŒæ­¥åŠŸèƒ½å¯èƒ½ç„¡æ³•æ­£å¸¸é‹ä½œã€‚');
              console.log('å»ºè­°ä½¿ç”¨æœ¬æ©Ÿä¼ºæœå™¨ï¼špython -m http.server 8000');
            }
            
            syncWithGoogleSheet(true);
            fetchCalendarEvents();
          }, []);

          useEffect(() => {
            const timer = setInterval(() => {
              const d = new Date();
              setNow(d);
              
              if (d.getHours() === 3 && d.getMinutes() === 0 && d.getSeconds() === 0) {
                fetchCalendarEvents();
              }
            }, 1000);
            
            return () => clearInterval(timer);
          }, [fetchCalendarEvents]);

          useEffect(() => {
            localStorage.setItem('slots', JSON.stringify(slots));
            localStorage.setItem('timetable', JSON.stringify(timetable));
            localStorage.setItem('templates', JSON.stringify(templates));
            if (lastSyncTime) {
              localStorage.setItem('lastSyncTime', lastSyncTime);
            }
          }, [slots, timetable, templates, lastSyncTime]);

          const getStatus = () => {
            const day = now.getDay();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const currentTimeStr = `${hours}:${minutes}`;
            
            const currentSlot = slots.find(s => currentTimeStr >= s.start && currentTimeStr < s.end);
            
            if (currentSlot) {
              const subject = timetable[day]?.[currentSlot.id];
              return {
                name: currentSlot.name,
                label: subject || 'ï¼ˆç©ºå ‚ï¼‰',
                isClass: !!subject
              };
            }
            
            return {
              name: 'ä¼‘æ¯',
              label: 'ä¸‹èª²æ™‚é–“',
              isClass: false
            };
          };

          const handleQuickAction = (title, sub) => {
            setBroadcast({ id: Date.now().toString(), btnName: 'Quick', title, subtitle: sub });
          };

          const handleTravelPublish = (dest) => {
            setBroadcast({ id: Date.now().toString(), btnName: 'Travel', title: `æˆ‘åœ¨${dest}`, subtitle: 'å¾ˆå¿«å°±å›ä¾†' });
            setIsTravelModalOpen(false);
          };

          return (
            <div className="min-h-screen bg-slate-950 text-white relative font-sans">
              
              {/* === æ–°æ•´åˆçš„ 3D æ‰‹å‹¢èƒŒæ™¯ === */}
              <GestureParticlesBackground />
              
              {isSyncing && (
                <div className="fixed top-4 right-4 z-[100] bg-blue-600/80 backdrop-blur px-3 md:px-4 py-2 rounded-full text-[10px] md:text-xs font-bold animate-pulse flex items-center gap-2">
                    <i className="fas fa-sync-alt fa-spin"></i>
                    é›²ç«¯åŒæ­¥ä¸­...
                </div>
              )}

              {showCorsWarning && (
                <div className="fixed top-4 left-2 right-2 md:left-1/2 md:right-auto md:-translate-x-1/2 z-[100] md:max-w-2xl">
                  <div className="bg-amber-500/95 backdrop-blur px-4 md:px-6 py-3 rounded-xl md:rounded-2xl shadow-xl border border-amber-400/50 flex items-center gap-3 md:gap-4">
                    <i className="fas fa-exclamation-triangle text-lg md:text-2xl text-white flex-shrink-0"></i>
                    <div className="flex-1 min-w-0">
                      <div className="text-xs md:text-sm font-bold text-white">âš ï¸ CORS è­¦å‘Š</div>
                      <div className="text-[10px] md:text-xs text-amber-100 mt-1 truncate">
                        å»ºè­°ä½¿ç”¨æœ¬æ©Ÿä¼ºæœå™¨: <code className="bg-black/20 px-1 rounded">python -m http.server 8000</code>
                      </div>
                    </div>
                    <button 
                      onClick={() => setShowCorsWarning(false)}
                      className="text-white hover:text-amber-200 transition-colors flex-shrink-0"
                    >
                      <i className="fas fa-times text-lg md:text-xl"></i>
                    </button>
                  </div>
                </div>
              )}

              {/* æ‰‹æ©Ÿç‰ˆï¼šå‚ç›´ä½ˆå±€ */}
              <div className="block md:hidden">
                <div className="avatar-box p-4">
                  <div className="relative group inline-block">
                      <div className="absolute -inset-1.5 bg-gradient-to-tr from-yellow-600 via-amber-400 to-yellow-200 rounded-full blur-sm opacity-70 group-hover:opacity-100 transition duration-500"></div>
                      <img src="https://luarnai.github.io/pic/mypic.jpg" alt="Dr. Luarn" className="relative w-24 h-24 rounded-full border-4 border-[#FFD700]/40 shadow-2xl object-cover" />
                  </div>
                </div>

                <div className="title-area w-full mt-4">
                  <div className="flex flex-col items-center justify-center">
                      <div className="drop-shadow-2xl text-center flex flex-col items-center gap-3">
                          <span style={{animation: 'pastel-shift 12s ease-in-out infinite', color: '#ffffff'}} className="text-3xl font-black tracking-widest">
                            æ¬’è€å¸«è³‡è¨Šçœ‹æ¿
                          </span>
                      </div>
                  </div>
                </div>

                <main className="relative z-10 flex flex-col min-h-[calc(100vh-300px)]">
                  <div className="flex-grow flex items-start justify-center p-4">
                    <MainDisplay 
                      now={now} 
                      status={getStatus()} 
                      broadcast={broadcast} 
                      onCloseBroadcast={() => setBroadcast(null)} 
                    />
                  </div>
                  
                  {/* æ‰‹æ©Ÿç‰ˆå°‡è¡Œäº‹æ›†é¡¯ç¤ºåœ¨ä¸‹æ–¹ */}
                  <div className="px-4 mb-4">
                    <div className="bg-white/10 rounded-xl p-4">
                        <h3 className="font-bold mb-2 flex items-center gap-2">
                           <i className="fas fa-calendar-alt"></i> è¿‘æœŸè¡Œç¨‹
                        </h3>
                        <p className="whitespace-pre-wrap text-sm">{calendarEvents}</p>
                    </div>
                  </div>

                  <Toolbar 
                    onOpenBroadcast={() => setIsBroadcastModalOpen(true)}
                    onOpenSettings={() => setIsSettingsModalOpen(true)}
                    onOpenTravel={() => setIsTravelModalOpen(true)}
                    onQuickAction={handleQuickAction}
                  />
                </main>
              </div>

              {/* æ¡Œé¢ç‰ˆï¼šåŸå§‹ä½ˆå±€ */}
              <div className="hidden md:block">
                <div className="title-area absolute top-8 left-0 right-0 lg:left-60 lg:right-64 z-20 flex flex-col items-center pointer-events-none">
                  <div className="flex flex-col items-center">
                      {/* é ­åƒ + åˆä½µå¾Œçš„æ¨™é¡Œ */}
                      <div className="flex items-center gap-6 drop-shadow-2xl mb-4 pointer-events-auto">
                          {/* é ­åƒ */}
                          <div className="relative group">
                              <div className="absolute -inset-1.5 bg-gradient-to-tr from-yellow-600 via-amber-400 to-yellow-200 rounded-full blur-sm opacity-70 group-hover:opacity-100 transition duration-500"></div>
                              <img src="https://luarnai.github.io/pic/mypic.jpg" alt="Dr. Luarn" className="relative w-24 h-24 rounded-full border-4 border-[#FFD700]/40 shadow-2xl object-cover" />
                          </div>
                          
                          {/* æ¬’è€å¸«è³‡è¨Šçœ‹æ¿ */}
                          <span style={{animation: 'pastel-shift 12s ease-in-out infinite', color: '#ffffff'}} className="text-6xl font-black tracking-tight">
                            æ¬’è€å¸«è³‡è¨Šçœ‹æ¿
                          </span>
                      </div>
                  </div>
                </div>

                <main className="relative z-10 h-screen flex flex-col lg:ml-60 lg:mr-64">
                  <div className="flex-grow flex items-center justify-center p-8">
                    <MainDisplay 
                      now={now} 
                      status={getStatus()} 
                      broadcast={broadcast} 
                      onCloseBroadcast={() => setBroadcast(null)} 
                    />
                  </div>

                  <Toolbar 
                    onOpenBroadcast={() => setIsBroadcastModalOpen(true)}
                    onOpenSettings={() => setIsSettingsModalOpen(true)}
                    onOpenTravel={() => setIsTravelModalOpen(true)}
                    onQuickAction={handleQuickAction}
                  />
                </main>
                
                {/* å·¦å´å›ºå®šèª²è¡¨ */}
                <TodaySchedule 
                  slots={slots}
                  timetable={timetable}
                  now={now}
                />
                
                {/* å³å´å›ºå®šè¡Œäº‹æ›† */}
                <RightSchedule 
                  events={calendarEvents}
                  onRefresh={fetchCalendarEvents}
                  isRefreshing={isRefreshingCalendar}
                />
              </div>

              {isBroadcastModalOpen && (
                <BroadcastModal 
                  templates={templates}
                  onUpdateTemplates={setTemplates}
                  onPublish={(t) => { setBroadcast(t); setIsBroadcastModalOpen(false); }}
                  onClose={() => setIsBroadcastModalOpen(false)}
                />
              )}

              {isSettingsModalOpen && (
                <SettingsModal 
                  slots={slots}
                  setSlots={setSlots}
                  timetable={timetable}
                  setTimetable={setTimetable}
                  lastSyncTime={lastSyncTime}
                  onSync={syncWithGoogleSheet}
                  onClose={() => setIsSettingsModalOpen(false)}
                />
              )}

              {isTravelModalOpen && (
                <TravelModal 
                  onPublish={handleTravelPublish}
                  onClose={() => setIsTravelModalOpen(false)}
                />
              )}
            </div>
          );
        }

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</body>
</html>